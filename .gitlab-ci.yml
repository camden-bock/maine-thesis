variables:
  LATEX_IMAGE: texlive/texlive:latest

stages:
  - build
  - release

build_assets:
  stage: build
  image:
    name: $LATEX_IMAGE
  script:
    - make gitlab
  artifacts:
    paths:
      - build/unpacked/maine-thesis.cls
      - maine-thesis.tds.zip
      - "maine-thesis-*.zip"
      - template.zip
    expire_in: 1 week
  # This section is updated from 'except:' to 'rules:'
  rules:
    - if: $CI_COMMIT_TAG

create_release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: build_assets
      artifacts: true
  script:
    - echo "Creating release for tag $CI_COMMIT_TAG"
    - |
      VERSION="${CI_COMMIT_TAG#v}"
      VERSIONED_ZIP_FILENAME="maine-thesis-${VERSION}.zip"
    - release-cli create --name "Release $CI_COMMIT_TAG" --tag-name $CI_COMMIT_TAG \
        --assets-link "{\"name\":\"maine-thesis.cls\", \"filepath\":\"build/unpacked/maine-thesis.cls\"}" \
        --assets-link "{\"name\":\"maine-thesis.tds.zip\", \"filepath\":\"maine-thesis.tds.zip\"}" \
        --assets-link "{\"name\":\"maine-thesis-template.zip\", \"filepath\":\"template.zip\"}" \
        --assets-link "{\"name\":\"${VERSIONED_ZIP_FILENAME}\", \"filepath\":\"${VERSIONED_ZIP_FILENAME}\"}"
  rules:
    - if: $CI_COMMIT_TAG